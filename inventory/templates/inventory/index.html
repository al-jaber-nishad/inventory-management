{% extends "base.html" %}
{% load static %}
{% block base %}
<div class="page-wrapper">
  <div class="content">
    <!-- Statistics Cards Row -->
    <div class="row">
      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash1.svg' %}" alt="img" /></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>
              ৳<span class="counters" data-count="{{ purchase_due_total|floatformat:2 }}">{{ purchase_due_total|floatformat:2 }}</span>
            </h5>
            <h6>Total Purchase Due</h6>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash1">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash2.svg' %}" alt="img" /></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>
              ৳<span class="counters" data-count="{{ sales_due_total|floatformat:2 }}">{{ sales_due_total|floatformat:2 }}</span>
            </h5>
            <h6>Total Sales Due</h6>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash2">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash3.svg' %}" alt="img" /></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>
              ৳<span class="counters" data-count="{{ total_sales_amount|floatformat:2 }}">{{ total_sales_amount|floatformat:2 }}</span>
            </h5>
            <h6>Total Sale Amount</h6>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash3">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash4.svg' %}" alt="img" /></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>
              <span class="counters" data-count="{{ low_stock_products|length }}">{{ low_stock_products|length }}</span>
            </h5>
            <h6>Low Stock Items</h6>
          </div>
        </div>
      </div>
    </div>

    <!-- Counter Cards Row -->
    <div class="row">
      <div class="col-lg-3 col-sm-6 col-12 d-flex">
        <div class="dash-count">
          <div class="dash-counts">
            <h4>{{ total_customers }}</h4>
            <h5>Customers</h5>
          </div>
          <div class="dash-imgs">
            <i data-feather="user"></i>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12 d-flex">
        <div class="dash-count das1">
          <div class="dash-counts">
            <h4>{{ total_suppliers }}</h4>
            <h5>Suppliers</h5>
          </div>
          <div class="dash-imgs">
            <i data-feather="user-check"></i>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12 d-flex">
        <div class="dash-count das2">
          <div class="dash-counts">
            <h4>{{ total_purchase_invoices }}</h4>
            <h5>Purchase Invoice</h5>
          </div>
          <div class="dash-imgs">
            <i data-feather="file-text"></i>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12 d-flex">
        <div class="dash-count das3">
          <div class="dash-counts">
            <h4>{{ total_sales_invoices }}</h4>
            <h5>Sales Invoice</h5>
          </div>
          <div class="dash-imgs">
            <i data-feather="file"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts and Recent Products Row -->
    <div class="row">
      <div class="col-lg-7 col-sm-12 col-12 d-flex">
        <div class="card flex-fill">
          <div class="card-header pb-0 d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Purchase & Sales</h5>
            <div class="graph-sets">
              <ul>
                <li><span>Sales</span></li>
                <li><span>Purchase</span></li>
              </ul>
              <div class="dropdown">
                <button class="btn btn-white btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                  {{ current_year }}
                  <img src="{% static 'img/icons/dropdown.svg' %}" alt="img" class="ms-2" />
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <li><a href="javascript:void(0);" class="dropdown-item">{{ current_year }}</a></li>
                  <li><a href="javascript:void(0);" class="dropdown-item">{{ current_year|add:-1 }}</a></li>
                  <li><a href="javascript:void(0);" class="dropdown-item">{{ current_year|add:-2 }}</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div id="sales_charts"></div>
          </div>
        </div>
      </div>
      <div class="col-lg-5 col-sm-12 col-12 d-flex">
        <div class="card flex-fill">
          <div class="card-header pb-0 d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Recently Added Products</h4>
            <div class="dropdown">
              <a href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false" class="dropset">
                <i class="fa fa-ellipsis-v"></i>
              </a>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><a href="#" class="dropdown-item">Product List</a></li>
                <li><a href="#" class="dropdown-item">Add Product</a></li>
              </ul>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive dataview">
              <table class="table">
                <thead>
                  <tr>
                    <th>SNo</th>
                    <th>Products</th>
                    <th>Price</th>
                    <th>Stock</th>
                  </tr>
                </thead>
                <tbody>
                  {% for product in recent_products %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td class="productimgname">
                      <a href="#" class="product-img">
                        {% if product.image %}
                          <img src="{{ product.image.url }}" alt="product" />
                        {% else %}
                          <img src="{% static 'img/product/default-product.jpg' %}" alt="product" />
                        {% endif %}
                      </a>
                      <a href="#">{{ product.name }}</a>
                    </td>
                    <td>৳{{ product.price|floatformat:2 }}</td>
                    <td>{{ product.stock }}</td>
                  </tr>
                  {% empty %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Low Stock Products Table -->
    <div class="card mb-0">
      <div class="card-body">
        <h4 class="card-title">Low Stock Products</h4>
        <div class="table-responsive dataview">
          <table class="table datatable">
            <thead>
              <tr>
                <th>SNo</th>
                <th>Product Code</th>
                <th>Product Name</th>
                <th>Brand Name</th>
                <th>Category Name</th>
                <th>Current Stock</th>
              </tr>
            </thead>
            <tbody>
              {% for item in low_stock_products %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td><a href="javascript:void(0);">{{ item.product.sku }}</a></td>
                <td class="productimgname">
                  <a class="product-img" href="#">
                    {% if item.product.image %}
                      <img src="{{ item.product.image.url }}" alt="product" />
                    {% else %}
                      <img src="{% static 'img/product/default-product.jpg' %}" alt="product" />
                    {% endif %}
                  </a>
                  <a href="#">{{ item.product.name }}</a>
                </td>
                <td>{{ item.product.brand.name|default:"N/A" }}</td>
                <td>{{ item.product.category.name|default:"N/A" }}</td>
                <td>
                  <span class="badge badge-danger">{{ item.stock }}</span>
                </td>
              </tr>
              {% empty %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

    <script src="{% static 'plugins/apexchart/apexcharts.min.js' %}"></script>

<script>
  // Chart data from Django context
  var salesChartData = {
    series: [{
      name: "Sales",
      type: "area",
      data: [{% for data in monthly_data %}{{ data.sales }}{% if not forloop.last %},{% endif %}{% endfor %}]
    }, {
      name: "Purchase",
      type: "line",
      data: [{% for data in monthly_data %}{{ data.purchases }}{% if not forloop.last %},{% endif %}{% endfor %}]
    }],
    chart: {
      height: 300,
      type: "line",
      zoom: {
        enabled: false
      }
    },
    stroke: {
      curve: "straight"
    },
    fill: {
      type: "solid",
      opacity: [0.35, 1]
    },
    labels: [{% for data in monthly_data %}"{{ data.month }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    markers: {
      size: 0
    },
    yaxis: [{
      title: {
        text: "Amount (৳)"
      }
    }],
    tooltip: {
      shared: true,
      intersect: false,
      y: {
        formatter: function (y) {
          if (typeof y !== "undefined") {
            return "৳" + y.toFixed(2);
          }
          return y;
        }
      }
    }
  };
  
  // Render chart
  if (document.getElementById("sales_charts")) {
    var salesChart = new ApexCharts(document.querySelector("#sales_charts"),);
    salesChart.render();
  }
</script>
{% endblock %}