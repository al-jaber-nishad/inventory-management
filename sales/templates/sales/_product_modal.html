<!-- Product Creation Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productName" class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="productName" name="name" required placeholder="e.g., iPhone 14 Pro">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productSku" class="form-label">SKU *</label>
                            <input type="text" class="form-control" id="productSku" name="sku" required placeholder="e.g., PROD-001">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productCategory" class="form-label">Category</label>
                            <select class="form-control" id="productCategory" name="category">
                                <option value="">-- Select Category --</option>
                                <!-- Categories will be loaded via AJAX -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productBrand" class="form-label">Brand</label>
                            <select class="form-control" id="productBrand" name="brand">
                                <option value="">-- Select Brand --</option>
                                <!-- Brands will be loaded via AJAX -->
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productUnit" class="form-label">Unit</label>
                            <select class="form-control" id="productUnit" name="unit">
                                <option value="">-- Select Unit --</option>
                                <!-- Units will be loaded via AJAX -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productColor" class="form-label">Color</label>
                            <select class="form-control" id="productColor" name="color">
                                <option value="">-- Select Color --</option>
                                <!-- Colors will be loaded via AJAX -->
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productPrice" class="form-label">Price *</label>
                            <input type="number" class="form-control" id="productPrice" name="price" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="col-md-6"></div>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" name="description" rows="3" placeholder="Product description (optional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProductBtn">Save Product</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Product Modal Functionality
    $(document).on('click', '.add-product-btn', function() {
        // Load dropdown options when modal is opened
        loadProductModalData();
        $('#productModal').modal('show');
    });
    
    function loadProductModalData() {
        // Load categories
        $.ajax({
            url: '/product/api/categories/',
            type: 'GET',
            success: function(response) {
                const categorySelect = $('#productCategory');
                categorySelect.empty();
                categorySelect.append('<option value="">-- Select Category --</option>');
                
                if (Array.isArray(response)) {
                    response.forEach(function(category) {
                        categorySelect.append(
                            `<option value="${category.id}">${category.name}</option>`
                        );
                    });
                }
            },
            error: function() {
                console.error('Failed to load categories');
            }
        });
        
        // Load brands
        $.ajax({
            url: '/product/api/brands/',
            type: 'GET',
            success: function(response) {
                const brandSelect = $('#productBrand');
                brandSelect.empty();
                brandSelect.append('<option value="">-- Select Brand --</option>');
                
                if (Array.isArray(response)) {
                    response.forEach(function(brand) {
                        brandSelect.append(
                            `<option value="${brand.id}">${brand.name}</option>`
                        );
                    });
                }
            },
            error: function() {
                console.error('Failed to load brands');
            }
        });
        
        // Load units
        $.ajax({
            url: '/product/api/units/',
            type: 'GET',
            success: function(response) {
                const unitSelect = $('#productUnit');
                unitSelect.empty();
                unitSelect.append('<option value="">-- Select Unit --</option>');
                
                if (Array.isArray(response)) {
                    response.forEach(function(unit) {
                        unitSelect.append(
                            `<option value="${unit.id}">${unit.name}</option>`
                        );
                    });
                }
            },
            error: function() {
                console.error('Failed to load units');
            }
        });
        
        // Load colors
        $.ajax({
            url: '/product/api/colors/',
            type: 'GET',
            success: function(response) {
                const colorSelect = $('#productColor');
                colorSelect.empty();
                colorSelect.append('<option value="">-- Select Color --</option>');
                
                if (Array.isArray(response)) {
                    response.forEach(function(color) {
                        colorSelect.append(
                            `<option value="${color.id}">${color.name}</option>`
                        );
                    });
                }
            },
            error: function() {
                console.error('Failed to load colors');
            }
        });
    }
    
    $('#saveProductBtn').click(function() {
        const form = $('#productForm');
        const formData = {
            name: $('#productName').val(),
            sku: $('#productSku').val(),
            category: $('#productCategory').val(),
            brand: $('#productBrand').val(),
            unit: $('#productUnit').val(),
            color: $('#productColor').val(),
            price: $('#productPrice').val(),
            description: $('#productDescription').val()
        };
        
        // Validate required fields
        if (!formData.name.trim()) {
            alert('Product name is required');
            return;
        }
        
        if (!formData.price.trim()) {
            alert('Price is required');
            return;
        }
        
        // Disable save button to prevent double submission
        $(this).prop('disabled', true).text('Saving...');
        
        // Make AJAX request to create product
        $.ajax({
            url: '/product/products/create-ajax/',
            type: 'POST',
            data: formData,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Add new product to all product select dropdowns in the page
                    $('select[name*="product"]').each(function() {
                        const productSelect = $(this);
                        const newOption = new Option(response.product.name, response.product.id, false, false);
                        productSelect.append(newOption);
                    });
                    
                    // Close modal and reset form
                    $('#productModal').modal('hide');
                    form[0].reset();
                    
                    // Show success message
                    Swal.fire({
                        title: 'Success',
                        text: 'Product created successfully',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                } else {
                    alert('Error creating product: ' + (response.message || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                console.error('Error creating product:', error);
                alert('Error creating product. Please try again.');
            },
            complete: function() {
                // Re-enable save button
                $('#saveProductBtn').prop('disabled', false).text('Save Product');
            }
        });
    });
    
    // Reset form when modal is hidden
    $('#productModal').on('hidden.bs.modal', function () {
        $('#productForm')[0].reset();
        $('#saveProductBtn').prop('disabled', false).text('Save Product');
    });
});
</script>