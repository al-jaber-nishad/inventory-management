<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0"
    />
    <meta name="description" content="Home Decor" />
    <meta
      name="keywords"
      content="admin, estimates, bootstrap, business, corporate, creative, management, minimal, modern,  html5, responsive"
    />
    <meta name="author" content="Al Jaber Nishad" />
    <meta name="robots" content="noindex, nofollow" />
    {% if title %}
      <title>{{ title }}</title>
    {% else %}
      <title>Home Decor POS</title>
    {% endif %}

    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="{% static 'img/favicon.png' %}"
    />

    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/bootstrap-datetimepicker.min.css' %}" />
    <link rel="stylesheet" href="{% static 'plugins/select2/css/select2.min.css' %}" />
    <link rel="stylesheet" href="{% static 'plugins/fontawesome/css/fontawesome.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'plugins/fontawesome/css/all.min.css' %}" />
    <link rel="stylesheet" href="{% static 'plugins/sweetalert/sweetalert2.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/sale-form.css' %}" />
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
  </head>
  <body>
    {% comment %} <div id="global-loader">
      <div class="whirly-loader"></div>
    </div> {% endcomment %}


    <div class="main-wrapper">
      {% include 'particals/navbar.html' %}
      {% comment %} {% include 'particals/sidebar.html' %} {% endcomment %}


<div class="page-wrapper">
    <div class="content mb-4">
        {% comment %} <div class="page-header">
            <div class="page-title">
                <h4>Sale Order</h4>
                <h6>{% if object %}Edit Sale Order{% else %}Create Sale Order{% endif %}</h6>
            </div>
        </div> {% endcomment %}
            
        {% if messages %}
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    Swal.fire({
                        title: '{% if is_error %}Error{% else %}Success{% endif %}',
                        html: '{% for message in messages %}<p>{{ message }}</p>{% endfor %}',
                        icon: '{% if is_error %}error{% else %}success{% endif %}',
                        confirmButtonText: 'OK'
                    });
                });
            </script>
        {% endif %}
        {% comment %} {% if form_errors %}
            <div class="alert alert-danger">
                <ul>
                {% for field, errors in form_errors.items %}
                    {% if field != '__all__' %}
                        <li><strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}</li>

                    {% else %}
                        {% for e in errors %}
                            <li>{{ e }}</li>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if formset_errors %}
            <div class="alert alert-warning mt-2">
                <strong>Item Errors:</strong>
                <ul>
                {% for f in formset_errors %}
                    <li>Item {{ forloop.counter }}:
                    <ul>
                        {% for field, errors in f.errors.items %}
                        <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
                        {% endfor %}
                    </ul>
                    </li>
                {% endfor %}
                </ul>
            </div>
        {% endif %} {% endcomment %}
        
        <form method="post" enctype="multipart/form-data" id="sale-form">
            {% csrf_token %}
            
            <!-- General Information -->

            <div class="row">
                <!-- Items Section -->
                <div class="col-lg-9">
                    <div class="card p-3 mb-3">

                        <div class="table-responsive">
                            {{ item_formset.management_form }}
                            <table class="table" id="items-table">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Product *
                                                <button type="button" class="btn btn-outline-primary btn-sm ms-1 add-product-btn" title="Add New Product">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                        </th>
                                        <th>Quantity *</th>
                                        <th>Unit Price *</th>
                                        <th>Discount(%)</th>
                                        <th>Discount</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="items-table-body">
                                    {% for form in item_formset %}
                                        <tr class="item-row">
                                            {{ form.id }}
                                            <td>
                                                {{ form.product }}
                                                {% if form.product.errors %}
                                                    <div class="text-danger small">{{ form.product.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.quantity }}
                                                {% if form.quantity.errors %}
                                                    <div class="text-danger small">{{ form.quantity.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.unit_price }}
                                                {% if form.unit_price.errors %}
                                                    <div class="text-danger small">{{ form.unit_price.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.discount_percentage }}
                                                {% if form.discount_percentage.errors %}
                                                    <div class="text-danger small">{{ form.discount_percentage.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.discount_amount }}
                                                {% if form.discount_amount.errors %}
                                                    <div class="text-danger small">{{ form.discount_amount.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="total-price">৳0.00</td>
                                            <td>
                                                <button type="button" class="add-item btn btn-added btn-sm">
                                                    <img src="{% static 'img/icons/plus.svg' %}" alt="img" class="me-1">
                                                </button>

                                                {% if form.instance.pk %}
                                                    {{ form.DELETE }}
                                                    <label for="{{ form.DELETE.id_for_label }}" class="btn btn-danger btn-sm">
                                                        <i class="fas fa-trash"></i>
                                                    </label>
                                                {% else %}
                                                    <button type="button" class="btn btn-danger btn-sm remove-item">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}

                                                
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Product Listing Section -->
                    {% include 'sales/_product_listing.html' %}

                    <div class="card p-3">
                        <div class="form-group">
                            <label for="{{ form.note.id_for_label }}">Notes</label>
                            {{ form.note }}
                        </div>
                    </div>
                </div>

                <!-- Summary Section -->
                {% comment %} <div class="col-lg-5">
                    <div class="card p-3 mb-3">
                        <h2 class="text-lg font-semibold mb-4">Order Summary</h2>
                        
                        <div class="space-y-3 mb-4">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Subtotal</span>
                                <span id="subtotal">৳0.00</span>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="{{ form.discount.id_for_label }}" class="text-muted">Discount</label>
                                <div style="width: 30%; height: 20%;">{{ form.discount }}</div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="{{ form.tax.id_for_label }}" class="text-muted">Tax</label>
                                <div style="width: 30%; height: 80%;">{{ form.tax }}</div>
                            </div>
                        </div>

                        
                        <div class="border-top pt-4">
                            <div class="d-flex justify-content-between font-weight-bold text-lg">
                                <span>Grand Total</span>
                                <span id="grand-total">৳0.00</span>
                            </div>
                        </div>
                    </div>
                </div> {% endcomment %}

                <div class="col-lg-3">
                    <div class="card p-3 mb-3">
                        <div class="row">
                            <div class="">
                                <h2 class="text-lg font-semibold mb-2">Sale Order #{{ form.invoice_number.value }}</h2>
                            </div>
                        </div>

                        
                        <div class="mandatory-fields">
                            {% comment %} <div class="col-lg-2 col-sm-6 col-12">
                                <div class="form-group">a
                                    <label for="{{ form.payment_ledger.id_for_label }}">Payment Ledger *</label>
                                    {{ form.payment_ledger }}
                                </div>
                            </div> {% endcomment %}

                            <div class="">
                                    {{ form.invoice_number.as_hidden }}
                            </div>

                            <div class="">
                                <div class="form-group" style="margin-bottom: 5px;">
                                    <label for="{{ form.sale_date.id_for_label }}">Sale Date</label>
                                    <div class="input-groupicon">
                                    <input type="text" name="sale_date" placeholder="Choose Date" class="datetimepicker" value="{{ sale_date }}">
                                        <a class="addonset">
                                            <img src="{% static 'img/icons/calendars.svg' %}" alt="img" />
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="">
                                <div class="form-group" style="margin-bottom: 5px;">
                                    <label for="{{ form.customer.id_for_label }}">Customer *</label>
                                    <div class="input-group">
                                        {{ form.customer }}
                                        <button type="button" class="btn btn-outline-primary btn-sm ms-1" id="add-customer-btn" title="Add New Customer">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>


                            {% comment %} <div class="col-lg-2 col-sm-6 col-12">
                                <div class="form-group">
                                    <label for="{{ form.invoice_number.id_for_label }}">Delivery Date</label>
                                    <div class="input-groupicon">
                                    <input type="text" name="due_date" placeholder="Choose Date" class="datetimepicker" value="{{ due_date }}">
                                        <a class="addonset">
                                            <img src="{% static 'img/icons/calendars.svg' %}" alt="img" />
                                        </a>
                                    </div>
                                </div>
                            </div> {% endcomment %}

                            <div class="">
                                <div class="form-group" style="margin-bottom: 5px;">
                                    <label for="{{ form.status.id_for_label }}">Status</label>
                                    {{ form.status }}
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">Order Summary</h2>
                        
                        <div class="space-y-3 mb-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal</span>
                                <span id="subtotal" class="font-bold">৳0.00</span>
                            </div>

                            <div class="flex justify-between">
                                <div class="flex items-center">
                                    <span class="text-gray-600 mr-2">Less</span>
                                </div>
                                {{ form.discount }}
                            </div>

                            <div class="flex justify-between">
                                <div class="flex items-center">
                                    <span class="text-gray-600 mr-2">Tax</span>
                                </div>
                                {{ form.tax }}
                            </div>
                        </div>
                        <hr>
                        <div class="border-t border-gray-200 mt-2">
                            <div class="flex justify-between font-bold">
                                <span>Grand Total</span>
                                <span id="grand-total">৳0.00</span>
                            </div>
                        </div>

                        <div class="flex justify-between mt-1">
                            <div class="flex items-center">
                                <span class="text-gray-600 mr-2">Paid</span>
                            </div>
                            {{ form.paid }}
                        </div>

                        <div class="flex justify-between mt-1">
                            <div class="flex items-center">
                                <span class="text-gray-600 mr-2">Due</span>
                            </div>
                            <span id="id_due_display" class="font-bold text-danger">৳0.00</span>
                            {{ form.due.as_hidden }}
                        </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 pt-3">
                        <button type="submit" name="action" value="confirm" class="btn btn-submit me-2">
                            <i class="fas fa-paper-plane me-1"></i>{% if object %}Update{% else %}Save{% endif %}
                        </button>
                        <button type="submit" name="action" value="draft" class="btn btn-secondary me-2">
                            <i class="fas fa-save me-1"></i>Save as Draft
                        </button>
                        <a href="{% url 'sale_list' %}" class="btn btn-cancel">Cancel</a>
                    </div>
                </div>
            </div>

            
        </form>
    </div>
</div>

<!-- Customer Creation Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerModalLabel">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customerName" class="form-label">Customer Name *</label>
                            <input type="text" class="form-control" id="customerName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customerPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="customerPhone" name="phone">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="customerAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="customerAddress" name="address" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomerBtn">Save Customer</button>
            </div>
        </div>
    </div>
</div>

<!-- Empty item row template -->
<template id="empty-item-row">
    <tr class="item-row">
        <td>
            <select name="items-__prefix__-product" class="form-control product-select select2_search" id="id_items-__prefix__-product">
                <option value="">Select product...</option>
                {% for product in item_formset.0.product.field.queryset %}
                    <option value="{{ product.id }}">{{ product }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="items-__prefix__-quantity" step="0.01" min="0.01" class="form-control quantity-input" id="id_items-__prefix__-quantity">
        </td>
        <td>
            <input type="number" name="items-__prefix__-unit_price" step="0.01" min="0.01" class="form-control price-input" id="id_items-__prefix__-unit_price">
        </td>
        <td>
            <input type="number" name="items-__prefix__-discount_percentage" step="0.01" min="0" max="100" class="form-control discount-percentage-input" id="id_items-__prefix__-discount_percentage" placeholder="0">
        </td>
        <td>
            <input type="number" name="items-__prefix__-discount_amount" step="0.01" min="0" class="form-control discount-amount-input" id="id_items-__prefix__-discount_amount" placeholder="0.00">
        </td>
        <td class="total-price">৳0.00</td>
        <td>
            <button type="button" class="add-item btn btn-added btn-sm">
                <img src="{% static 'img/icons/plus.svg' %}" alt="img" class="me-1">
            </button>

            <button type="button" class="btn btn-danger btn-sm remove-item">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>

    {% include 'sales/_product_modal.html' %}


    <div id="footer">
        <div class="text-center">
          © {% now "Y" %} Home Decor, Dhaka. All rights reserved.
        </div>
      </div>
    </div>


    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/moment.min.js' %}"></script>
    <script src="{% static 'js/select2.min.js' %}"></script>
    <script src="{% static 'js/bootstrap-datetimepicker.min.js' %}"></script>
    <script src="{% static 'plugins/sweetalert/sweetalert2.all.min.js' %}"></script>
    <script src="{% static 'js/feather.min.js' %}"></script>
    <script src="{% static 'js/script.js' %}"></script>
    <script src="{% static 'js/sale-form.js' %}"></script>

  </body>
</html>
