<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0"
    />
    <meta name="description" content="Home Decor" />
    <meta
      name="keywords"
      content="admin, estimates, bootstrap, business, corporate, creative, management, minimal, modern,  html5, responsive"
    />
    <meta name="author" content="Al Jaber Nishad" />
    <meta name="robots" content="noindex, nofollow" />
    {% if title %}
      <title>{{ title }}</title>
    {% else %}
      <title>Home Decor POS</title>
    {% endif %}

    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="{% static 'img/favicon.png' %}"
    />

    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/bootstrap-datetimepicker.min.css' %}" />
    <link rel="stylesheet" href="{% static 'plugins/select2/css/select2.min.css' %}" />
    {% comment %} <link rel="stylesheet" href="{% static 'css/animate.css' %}" /> {% endcomment %}
    {% comment %} <link rel="stylesheet" href="{% static 'css/dataTables.bootstrap4.min.css' %}" /> {% endcomment %}
    <link rel="stylesheet" href="{% static 'plugins/fontawesome/css/fontawesome.min.css' %}"/>
    <link rel="stylesheet" href="{% static 'plugins/fontawesome/css/all.min.css' %}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>

    <style>
      #footer {
        padding: 0.5rem 0;
        background-color: #f3f3f3;
        position: fixed;
        bottom: 0;
        width: calc(100% - 260px); 
        margin-left: 260px;
        /* margin-top: auto; */
        transition: all 0.2s ease;
      }

      @media (max-width: 991px) {
        .sidebar {
          margin-left: -575px;
        }
        #footer {
          width: 100%;
          margin-left: 0;
        }
      }
      .mini-sidebar.expand-menu #footer {
        width: calc(100% - 260px);
        margin-left: 260px;
      }
      .mini-sidebar #footer {
        width: calc(100% - 80px);
        margin-left: 80px;
      }
    </style>
  </head>
  <body>
    {% comment %} <div id="global-loader">
      <div class="whirly-loader"></div>
    </div> {% endcomment %}


    <div class="main-wrapper">
      {% include 'particals/navbar.html' %}
      {% comment %} {% include 'particals/sidebar.html' %} {% endcomment %}


<style>
    items-table th:nth-child(1),
    #items-table td:nth-child(1) {
        width: 30%;
    }

    #items-table th:nth-child(2),
    #items-table td:nth-child(2) {
        width: 10%;
    }

    #items-table th:nth-child(3),
    #items-table td:nth-child(3) {
        width: 10%;
    }

    #items-table th:nth-child(4),
    #items-table td:nth-child(4) {
        width: 10%;
    }

    #items-table th:nth-child(5),
    #items-table td:nth-child(5) {
        width: 10%;
    }

    #items-table th:nth-child(6),
    #items-table td:nth-child(6) {
        width: 10%;
    }

    #items-table th:nth-child(7),
    #items-table td:nth-child(7) {
        width: 10%;
    }

    #items-table th:nth-child(8),
    #items-table td:nth-child(8) {
        width: 10%;
    }

    #items-table {
        table-layout: fixed;
    }
    .item-row:hover .remove-item {
        opacity: 1;
    }
    .remove-item {
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    #items-table input {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
    }
    .total-price {
        font-weight: bold;
        font-size: 17px;
    }
    input[type="checkbox"][id*="DELETE"] {
        display: none;
    }
    .btn:focus-visible {
    outline: none;
    border: 2px solid #0d6efd;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }

    .form-group .input-group{
        padding-right: 35px;
    }

    .select2-selection__rendered {
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        display: block !important;
    }

    .select2-container .select2-selection--single {
        overflow: hidden !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        width: 100% !important;
        display: block !important;
    }

    .product-select {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    #items-table .select2-container {
        max-width: 100% !important;
        width: 100% !important;
    }

    .page-wrapper{
        margin: 0;
    }

</style>


<div class="page-wrapper">
    <div class="content mb-4">
        {% comment %} <div class="page-header">
            <div class="page-title">
                <h4>Sale Order</h4>
                <h6>{% if object %}Edit Sale Order{% else %}Create Sale Order{% endif %}</h6>
            </div>
        </div> {% endcomment %}
            
        {% if messages %}
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    Swal.fire({
                        title: '{% if is_error %}Error{% else %}Success{% endif %}',
                        html: '{% for message in messages %}<p>{{ message }}</p>{% endfor %}',
                        icon: '{% if is_error %}error{% else %}success{% endif %}',
                        confirmButtonText: 'OK'
                    });
                });
            </script>
        {% endif %}
        {% comment %} {% if form_errors %}
            <div class="alert alert-danger">
                <ul>
                {% for field, errors in form_errors.items %}
                    {% if field != '__all__' %}
                        <li><strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}</li>

                    {% else %}
                        {% for e in errors %}
                            <li>{{ e }}</li>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if formset_errors %}
            <div class="alert alert-warning mt-2">
                <strong>Item Errors:</strong>
                <ul>
                {% for f in formset_errors %}
                    <li>Item {{ forloop.counter }}:
                    <ul>
                        {% for field, errors in f.errors.items %}
                        <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
                        {% endfor %}
                    </ul>
                    </li>
                {% endfor %}
                </ul>
            </div>
        {% endif %} {% endcomment %}
        
        <form method="post" enctype="multipart/form-data" id="sale-form">
            {% csrf_token %}
            
            <!-- General Information -->

            <div class="row">
                <!-- Items Section -->
                <div class="col-lg-9">
                    <div class="card p-3 mb-3">

                        <div class="table-responsive">
                            {{ item_formset.management_form }}
                            <table class="table" id="items-table">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Product *
                                                <button type="button" class="btn btn-outline-primary btn-sm ms-1 add-product-btn" title="Add New Product">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                        </th>
                                        <th>Quantity *</th>
                                        <th>Unit Price *</th>
                                        <th>Discount(%)</th>
                                        <th>Discount</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="items-table-body">
                                    {% for form in item_formset %}
                                        <tr class="item-row">
                                            {{ form.id }}
                                            <td>
                                                {{ form.product }}
                                                {% if form.product.errors %}
                                                    <div class="text-danger small">{{ form.product.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.quantity }}
                                                {% if form.quantity.errors %}
                                                    <div class="text-danger small">{{ form.quantity.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.unit_price }}
                                                {% if form.unit_price.errors %}
                                                    <div class="text-danger small">{{ form.unit_price.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.discount_percentage }}
                                                {% if form.discount_percentage.errors %}
                                                    <div class="text-danger small">{{ form.discount_percentage.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.discount_amount }}
                                                {% if form.discount_amount.errors %}
                                                    <div class="text-danger small">{{ form.discount_amount.errors|first }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="total-price">৳0.00</td>
                                            <td>
                                                <button type="button" class="add-item btn btn-added btn-sm">
                                                    <img src="{% static 'img/icons/plus.svg' %}" alt="img" class="me-1">
                                                </button>

                                                {% if form.instance.pk %}
                                                    {{ form.DELETE }}
                                                    <label for="{{ form.DELETE.id_for_label }}" class="btn btn-danger btn-sm">
                                                        <i class="fas fa-trash"></i>
                                                    </label>
                                                {% else %}
                                                    <button type="button" class="btn btn-danger btn-sm remove-item">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}

                                                
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Product Listing Section -->
                    {% include 'sales/_product_listing.html' %}

                    <div class="card p-3">
                        <div class="form-group">
                            <label for="{{ form.note.id_for_label }}">Notes</label>
                            {{ form.note }}
                        </div>
                    </div>
                </div>

                <!-- Summary Section -->
                {% comment %} <div class="col-lg-5">
                    <div class="card p-3 mb-3">
                        <h2 class="text-lg font-semibold mb-4">Order Summary</h2>
                        
                        <div class="space-y-3 mb-4">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Subtotal</span>
                                <span id="subtotal">৳0.00</span>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="{{ form.discount.id_for_label }}" class="text-muted">Discount</label>
                                <div style="width: 30%; height: 20%;">{{ form.discount }}</div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="{{ form.tax.id_for_label }}" class="text-muted">Tax</label>
                                <div style="width: 30%; height: 80%;">{{ form.tax }}</div>
                            </div>
                        </div>

                        
                        <div class="border-top pt-4">
                            <div class="d-flex justify-content-between font-weight-bold text-lg">
                                <span>Grand Total</span>
                                <span id="grand-total">৳0.00</span>
                            </div>
                        </div>
                    </div>
                </div> {% endcomment %}

                <script src="https://cdn.tailwindcss.com"></script>
                <div class="col-lg-3">
                    <div class="card p-3 mb-3">
                        <div class="row">
                            <div class="">
                                <h2 class="text-lg font-semibold mb-2">Sale Order #{{ form.invoice_number.value }}</h2>
                            </div>
                        </div>

                        
                        <div class="mandatory-fields">
                            {% comment %} <div class="col-lg-2 col-sm-6 col-12">
                                <div class="form-group">a
                                    <label for="{{ form.payment_ledger.id_for_label }}">Payment Ledger *</label>
                                    {{ form.payment_ledger }}
                                </div>
                            </div> {% endcomment %}

                            <div class="">
                                    {{ form.invoice_number.as_hidden }}
                            </div>

                            <div class="">
                                <div class="form-group" style="margin-bottom: 5px;">
                                    <label for="{{ form.sale_date.id_for_label }}">Sale Date</label>
                                    <div class="input-groupicon">
                                    <input type="text" name="sale_date" placeholder="Choose Date" class="datetimepicker" value="{{ sale_date }}">
                                        <a class="addonset">
                                            <img src="{% static 'img/icons/calendars.svg' %}" alt="img" />
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="">
                                <div class="form-group" style="margin-bottom: 5px;">
                                    <label for="{{ form.customer.id_for_label }}">Customer *</label>
                                    <div class="input-group">
                                        {{ form.customer }}
                                        <button type="button" class="btn btn-outline-primary btn-sm ms-1" id="add-customer-btn" title="Add New Customer">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>


                            {% comment %} <div class="col-lg-2 col-sm-6 col-12">
                                <div class="form-group">
                                    <label for="{{ form.invoice_number.id_for_label }}">Delivery Date</label>
                                    <div class="input-groupicon">
                                    <input type="text" name="due_date" placeholder="Choose Date" class="datetimepicker" value="{{ due_date }}">
                                        <a class="addonset">
                                            <img src="{% static 'img/icons/calendars.svg' %}" alt="img" />
                                        </a>
                                    </div>
                                </div>
                            </div> {% endcomment %}

                            <div class="">
                                <div class="form-group" style="margin-bottom: 5px;">
                                    <label for="{{ form.status.id_for_label }}">Status</label>
                                    {{ form.status }}
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">Order Summary</h2>
                        
                        <div class="space-y-3 mb-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal</span>
                                <span id="subtotal" class="font-bold">৳0.00</span>
                            </div>

                            <div class="flex justify-between">
                                <div class="flex items-center">
                                    <span class="text-gray-600 mr-2">Less</span>
                                </div>
                                {{ form.discount }}
                            </div>

                            <div class="flex justify-between">
                                <div class="flex items-center">
                                    <span class="text-gray-600 mr-2">Tax</span>
                                </div>
                                {{ form.tax }}
                            </div>
                        </div>
                        <hr>
                        <div class="border-t border-gray-200 mt-2">
                            <div class="flex justify-between font-bold">
                                <span>Grand Total</span>
                                <span id="grand-total">৳0.00</span>
                            </div>
                        </div>

                        <div class="flex justify-between mt-1">
                            <div class="flex items-center">
                                <span class="text-gray-600 mr-2">Paid</span>
                            </div>
                            {{ form.paid }}
                        </div>

                        <div class="flex justify-between mt-1">
                            <div class="flex items-center">
                                <span class="text-gray-600 mr-2">Due</span>
                            </div>
                            <span id="id_due_display" class="font-bold text-danger">৳0.00</span>
                            {{ form.due.as_hidden }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 pt-3">
                <div class="d-flex justify-content-end gap-2">
                    <button type="submit" name="action" value="confirm" class="btn btn-submit me-2">
                        <i class="fas fa-paper-plane me-1"></i>{% if object %}Update{% else %}Save{% endif %}
                    </button>
                    <button type="submit" name="action" value="draft" class="btn btn-secondary me-2">
                        <i class="fas fa-save me-1"></i>Save as Draft
                    </button>
                    <a href="{% url 'sale_list' %}" class="btn btn-cancel">Cancel</a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Customer Creation Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerModalLabel">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customerName" class="form-label">Customer Name *</label>
                            <input type="text" class="form-control" id="customerName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customerPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="customerPhone" name="phone">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="customerAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="customerAddress" name="address" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomerBtn">Save Customer</button>
            </div>
        </div>
    </div>
</div>

<!-- Empty item row template -->
<template id="empty-item-row">
    <tr class="item-row">
        <td>
            <select name="items-__prefix__-product" class="form-control product-select select2_search" id="id_items-__prefix__-product">
                <option value="">Select product...</option>
                {% for product in item_formset.0.product.field.queryset %}
                    <option value="{{ product.id }}">{{ product }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="items-__prefix__-quantity" step="0.01" min="0.01" class="form-control quantity-input" id="id_items-__prefix__-quantity">
        </td>
        <td>
            <input type="number" name="items-__prefix__-unit_price" step="0.01" min="0.01" class="form-control price-input" id="id_items-__prefix__-unit_price">
        </td>
        <td>
            <input type="number" name="items-__prefix__-discount_percentage" step="0.01" min="0" max="100" class="form-control discount-percentage-input" id="id_items-__prefix__-discount_percentage" placeholder="0">
        </td>
        <td>
            <input type="number" name="items-__prefix__-discount_amount" step="0.01" min="0" class="form-control discount-amount-input" id="id_items-__prefix__-discount_amount" placeholder="0.00">
        </td>
        <td class="total-price">৳0.00</td>
        <td>
            <button type="button" class="add-item btn btn-added btn-sm">
                <img src="{% static 'img/icons/plus.svg' %}" alt="img" class="me-1">
            </button>

            <button type="button" class="btn btn-danger btn-sm remove-item">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>

<script>

function initSelect2() {
$('.select2_search').select2({
});
}

$(document).ready(function() {
    initSelect2();  // initial load

    $(document).on('select2:open', () => {
        setTimeout(() => {
            document.querySelector('.select2-container--open .select2-search__field')?.focus();
        }, 0);
    });

    // Set current date on form load if field is empty
    const saleDateInput = $('input[name="sale_date"]');
    if (!saleDateInput.val()) {
        const today = new Date();
        const formattedDate = today.getFullYear() + '-' +
                            String(today.getMonth() + 1).padStart(2, '0') + '-' +
                            String(today.getDate()).padStart(2, '0');
        saleDateInput.val(formattedDate);
    }

    let formCount = parseInt($('#id_items-TOTAL_FORMS').val());
    
    // Add new item row
    $(document).on('click', '.add-item', function() {
        const template = $('#empty-item-row').html();
        const newRow = template.replace(/__prefix__/g, formCount);
        $('#items-table-body').append(newRow);
        formCount++;
        $('#id_items-TOTAL_FORMS').val(formCount);

        initSelect2();
        updateCalculations();
    });
    
    // Remove item row
    $(document).on('click', '.remove-item', function() {
        $(this).closest('tr').remove();
        updateCalculations();
    });
    
    // Handle product selection to populate price
    $(document).on('change', 'select[name*="product"]', function() {
        const productId = $(this).val();
        const row = $(this).closest('tr');
        const priceInput = row.find('.price-input');
        
        if (productId) {
            // Fetch product price from API
            $.get(`/sale/api/product/${productId}/price/`)
                .done(function(data) {
                    priceInput.val(data.price);
                    updateCalculations();
                })
                .fail(function() {
                    console.error('Failed to fetch product price');
                });
        } else {
            priceInput.val('');
            updateCalculations();
        }
    });
    
    // Calculate totals when inputs change
    $(document).on('input', '.quantity-input, .price-input, .discount-percentage-input, .discount-amount-input, #id_discount, #id_tax, #id_paid, #id_due', function() {
        updateCalculations();
    });

    // When discount percentage changes, update discount amount
    $(document).on('input', '.discount-percentage-input', function() {
        const row = $(this).closest('tr');
        const quantity = parseFloat(row.find('.quantity-input').val()) || 0;
        const unitPrice = parseFloat(row.find('.price-input').val()) || 0;
        const discountPercentage = parseFloat($(this).val()) || 0;

        const subtotal = quantity * unitPrice;
        const discountAmount = (subtotal * discountPercentage) / 100;

        row.find('.discount-amount-input').val(discountAmount.toFixed(2));
        updateCalculations();
    });

    // When discount amount changes, update discount percentage
    $(document).on('input', '.discount-amount-input', function() {
        const row = $(this).closest('tr');
        const quantity = parseFloat(row.find('.quantity-input').val()) || 0;
        const unitPrice = parseFloat(row.find('.price-input').val()) || 0;
        const discountAmount = parseFloat($(this).val()) || 0;

        const subtotal = quantity * unitPrice;
        const discountPercentage = subtotal > 0 ? (discountAmount / subtotal * 100) : 0;

        row.find('.discount-percentage-input').val(discountPercentage.toFixed(2));
        updateCalculations();
    });
    
    // Handle form submission with action
    $('button[name="action"]').click(function() {
        const action = $(this).val();
        if (action === 'draft') {
            $('#id_status').val('draft');
        } else if (action === 'confirm') {
            $('#id_status').val('confirmed');
        }
    });
    
    function updateCalculations() {
        let subtotal = 0;

        // Calculate each row total and sum up subtotal
        $('.item-row').each(function() {
            const quantity = parseFloat($(this).find('.quantity-input').val()) || 0;
            const unitPrice = parseFloat($(this).find('.price-input').val()) || 0;
            const discountAmount = parseFloat($(this).find('.discount-amount-input').val()) || 0;

            // Calculate subtotal for this row (before discount)
            const rowSubtotal = quantity * unitPrice;

            // Calculate total after discount
            const total = rowSubtotal - discountAmount;

            // Update row displays
            $(this).find('.total-price').text('৳' + total.toFixed(2));

            // Add to overall subtotal (after row-level discounts)
            subtotal += total;
        });
        
        const globalDiscount = parseFloat($('#id_discount').val()) || 0;
        const tax = parseFloat($('#id_tax').val()) || 0;
        const paid = parseFloat($('#id_paid').val()) || 0;
        const grandTotal = subtotal - globalDiscount + tax;
        const due_amount = grandTotal - paid;

        
        $('#subtotal').text('৳' + subtotal.toFixed(2));
        $('#grand-total').text('৳' + grandTotal.toFixed(2));
        $('#id_due_display').text('৳' + due_amount.toFixed(2));
        $('#id_due').val(due_amount.toFixed(2)); 
    }
    
    // Initial calculation
    updateCalculations();
    
    // Initialize Select2 for customer dropdown
    if ($.fn.select2) {
        $('.select2_search').select2({
            width: '100%',
            placeholder: 'Select an option'
        });
    }
    
    // Customer Modal Functionality
    $('#add-customer-btn').click(function() {
        $('#customerModal').modal('show');
    });
    
    $('#saveCustomerBtn').click(function() {
        const form = $('#customerForm');
        const formData = {
            name: $('#customerName').val(),
            phone: $('#customerPhone').val(),
            address: $('#customerAddress').val()
        };
        
        // Validate required fields
        if (!formData.name.trim()) {
            alert('Customer name is required');
            return;
        }
        
        // Disable save button to prevent double submission
        $(this).prop('disabled', true).text('Saving...');
        
        // Make AJAX request to create customer
        $.ajax({
            url: '/people/customers/create-ajax/',
            type: 'POST',
            data: formData,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Add new customer to select2 dropdown
                    const customerSelect = $('#id_customer');
                    const newOption = new Option(response.customer.name, response.customer.id, true, true);
                    customerSelect.append(newOption).trigger('change');
                    
                    // Close modal and reset form
                    $('#customerModal').modal('hide');
                    form[0].reset();
                    
                    // Show success message
                    Swal.fire({
                        title: 'Success',
                        text: 'Customer created successfully',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                } else {
                    alert('Error creating customer: ' + (response.message || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                console.error('Error creating customer:', error);
                alert('Error creating customer. Please try again.');
            },
            complete: function() {
                // Re-enable save button
                $('#saveCustomerBtn').prop('disabled', false).text('Save Customer');
            }
        });
    });
    
    // Reset form when modal is hidden
    $('#customerModal').on('hidden.bs.modal', function () {
        $('#customerForm')[0].reset();
        $('#saveCustomerBtn').prop('disabled', false).text('Save Customer');
    });
});
</script>

    {% include 'sales/_product_modal.html' %}


    <div id="footer">
        <div class="text-center">
          © {% now "Y" %} Home Decor, Dhaka. All rights reserved.
        </div>
      </div>
    </div>


  
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/moment.min.js' %}"></script>
    <script src="{% static 'js/select2.min.js' %}"></script>
    <script src="{% static 'js/bootstrap-datetimepicker.min.js' %}"></script>
    <script src="{% static 'plugins/sweetalert/sweetalert2.all.min.js' %}"></script>


    <script src="{% static 'js/feather.min.js' %}"></script>
    {% comment %} <script src="{% static 'js/jquery.slimscroll.min.js' %}"></script> {% endcomment %}
    {% comment %} <script src="{% static 'js/jquery.dataTables.min.js' %}"></script> {% endcomment %}
    {% comment %} <script src="{% static 'js/dataTables.bootstrap4.min.js' %}"></script> {% endcomment %}
    {% comment %} <script src="{% static 'plugins/select2/js/select2.min.js' %}"></script> {% endcomment %}
    {% comment %} <script src="{% static 'plugins/select2/js/custom-select.js' %}"></script> {% endcomment %}
    {% comment %} <script src="{% static 'plugins/apexchart/apexcharts.min.js' %}"></script> {% endcomment %}
    {% comment %} <script src="{% static 'plugins/apexchart/chart-data.js' %}"></script> {% endcomment %}
    {% comment %} <script src="{% static 'plugins/sweetalert/sweetalerts.min.js' %}"></script> {% endcomment %}
    {% comment %} <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> {% endcomment %}
    {% comment %} <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script> {% endcomment %}
    <script src="{% static 'js/script.js' %}"></script>


    <script>
  // Add select2 search functionality in the dropdown
  $(document).ready(function() {
      $('.select2_search').select2();
      // Focus search box when dropdown opens
      $(document).on('select2:open', () => {
          setTimeout(() => {
              document.querySelector('.select2-container--open .select2-search__field')?.focus();
          }, 0);
      });
  });

    {% comment %} 
      document.addEventListener('DOMContentLoaded', function() {      
        var submitButton = document.getElementById('submitButton');
        var form = uploadButton.closest('form');
        submitButton.addEventListener('click', function() {
          submitButton.disabled = true;
        });
      });
    {% endcomment %}


    document.querySelectorAll('.delete-btn').forEach(function(element) {
      element.addEventListener('click', function(e) {
          e.preventDefault();
          const url = this.getAttribute('data-url');
          Swal.fire({
              title: 'Are you sure?',
              text: "You won't be able to revert this!",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes, delete it!'
          }).then((result) => {
              if (result.isConfirmed) {
                  fetch(url, {
                      method: 'POST',
                      headers: {
                          'X-CSRFToken': '{{ csrf_token }}',
                          'Content-Type': 'application/json'
                      }
                  }).then(response => {
                      console.log(response)
                      if (response.ok) {
                          Swal.fire({
                              title: 'Deleted!',
                              icon: 'success'
                          }).then(() => {
                              window.location.reload();
                          });
                      } 
                      else {
                        console.log(response)
                          Swal.fire({
                              title: 'Error!',
                              html: '{{ errors }}',
                              icon: 'error',
                              confirmButtonText: 'error'
                          });
                      }
                  });
              }
          });
        });
      });
    
  </script>

  </body>
</html>
