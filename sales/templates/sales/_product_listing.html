{% load static %}

<style>
    .product-listing-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
        max-height: 525px;
        overflow-y: auto;
        padding: 10px;
    }

    .product-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .product-card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        transform: translateY(-2px);
    }

    .product-card.selected {
        border-color: #28a745;
        background-color: #f0f8f4;
    }

    .product-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 6px;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
    }

    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .product-image.no-image {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 48px;
        font-weight: bold;
    }

    .product-info {
        text-align: center;
    }

    .product-name {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 4px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .product-brand {
        font-size: 11px;
        color: #666;
        margin-bottom: 4px;
    }

    .product-price {
        font-weight: bold;
        color: #007bff;
        font-size: 14px;
        margin-bottom: 4px;
    }

    .product-stock {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
    }

    .stock-in {
        background: #d4edda;
        color: #155724;
    }

    .stock-out {
        background: #f8d7da;
        color: #721c24;
    }

    .filter-section {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .filter-section .form-control,
    .filter-section .form-select {
        flex: 1;
        min-width: 150px;
    }

    .no-products {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    .product-card .add-icon {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .product-card:hover .add-icon {
        display: flex;
    }

    .product-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
        background: #f5f5f5;
    }

    .product-card.disabled::after {
        content: "Already Added";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
    }

    .pagination-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
    }

    .pagination-info {
        font-size: 13px;
        color: #666;
    }

    .pagination-controls {
        display: flex;
        gap: 5px;
    }

    .pagination-controls button {
        padding: 5px 12px;
        font-size: 13px;
    }
</style>

<div class="card p-3 mb-3 product-listing-section">
    <h5 class="mb-3">Quick Product Selection</h5>

    <!-- Filters -->
    <div class="filter-section">
        <input type="text"
               id="product-search"
               class="form-control"
               placeholder="Search products...">

        <select id="category-filter" class="form-select">
            <option value="">All Categories</option>
        </select>

        <select id="brand-filter" class="form-select">
            <option value="">All Brands</option>
        </select>

        <button type="button" class="btn btn-secondary btn-sm" id="clear-filters">
            <i class="fas fa-redo"></i> Clear
        </button>
    </div>

    <!-- Product Grid -->
    <div id="product-grid" class="product-grid">
        <div class="no-products">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Loading products...</p>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-section">
        <div class="pagination-info">
            Showing <span id="page-start">0</span>-<span id="page-end">0</span> of <span id="total-products">0</span> products
        </div>
        <div class="pagination-controls">
            <button type="button" class="btn btn-sm btn-outline-primary" id="prev-page" disabled>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="next-page" disabled>
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    let productsData = [];
    let currentPage = 1;
    const productsPerPage = 12;

    // Load initial data
    loadFilters();
    loadProducts();

    // Load filter options
    function loadFilters() {
        // Load categories
        $.get('/product/api/categories/', function(categories) {
            const categoryFilter = $('#category-filter');
            categories.forEach(function(cat) {
                categoryFilter.append(`<option value="${cat.id}">${cat.name}</option>`);
            });
        });

        // Load brands
        $.get('/product/api/brands/', function(brands) {
            const brandFilter = $('#brand-filter');
            brands.forEach(function(brand) {
                brandFilter.append(`<option value="${brand.id}">${brand.name}</option>`);
            });
        });
    }

    // Load products
    function loadProducts(filters = {}) {
        $.ajax({
            url: '/product/api/products/',
            type: 'GET',
            data: filters,
            success: function(response) {
                productsData = response;
                currentPage = 1;
                renderProducts();
                updatePaginationInfo();
            },
            error: function() {
                $('#product-grid').html(`
                    <div class="no-products">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                        <p class="mt-2">Failed to load products</p>
                    </div>
                `);
            }
        });
    }

    // Get list of already selected product IDs
    function getSelectedProductIds() {
        const selectedIds = [];
        $('.item-row').each(function() {
            const productSelect = $(this).find('select[name*="product"]');
            const productId = productSelect.val();
            if (productId) {
                selectedIds.push(productId);
            }
        });
        return selectedIds;
    }

    // Render products
    function renderProducts() {
        const grid = $('#product-grid');
        grid.empty();

        if (productsData.length === 0) {
            grid.html(`
                <div class="no-products">
                    <i class="fas fa-box-open fa-2x"></i>
                    <p class="mt-2">No products found</p>
                </div>
            `);
            return;
        }

        // Get already selected products
        const selectedProductIds = getSelectedProductIds();

        // Calculate pagination
        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const paginatedProducts = productsData.slice(startIndex, endIndex);

        paginatedProducts.forEach(function(product) {
            const stockClass = product.stock > 0 ? 'stock-in' : 'stock-out';
            const stockText = product.stock > 0 ? `Stock: ${product.stock}` : 'Out of Stock';

            const imageHtml = product.image
                ? `<img src="${product.image}" alt="${product.name}">`
                : `<div class="no-image">${product.name.charAt(0).toUpperCase()}</div>`;

            // Check if product is already selected
            const isDisabled = selectedProductIds.includes(product.id.toString());
            const disabledClass = isDisabled ? 'disabled' : '';

            const card = $(`
                <div class="product-card ${disabledClass}" data-product-id="${product.id}" data-product-price="${product.price}">
                    <div class="add-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="product-image">
                        ${imageHtml}
                    </div>
                    <div class="product-info">
                        <div class="product-name" title="${product.name}">${product.name}</div>
                        ${product.brand ? `<div class="product-brand">${product.brand}</div>` : ''}
                        <div class="product-price">à§³${parseFloat(product.price).toFixed(2)}</div>
                        <div class="product-stock ${stockClass}">${stockText}</div>
                    </div>
                </div>
            `);

            grid.append(card);
        });
    }

    // Update pagination info
    function updatePaginationInfo() {
        const totalProducts = productsData.length;
        const startIndex = totalProducts === 0 ? 0 : (currentPage - 1) * productsPerPage + 1;
        const endIndex = Math.min(currentPage * productsPerPage, totalProducts);
        const totalPages = Math.ceil(totalProducts / productsPerPage);

        $('#page-start').text(startIndex);
        $('#page-end').text(endIndex);
        $('#total-products').text(totalProducts);

        // Update button states
        $('#prev-page').prop('disabled', currentPage === 1);
        $('#next-page').prop('disabled', currentPage >= totalPages || totalProducts === 0);
    }

    // Handle product card click
    $(document).on('click', '.product-card', function() {
        // Prevent clicking on disabled cards
        if ($(this).hasClass('disabled')) {
            return;
        }

        const productId = $(this).data('product-id');
        const productPrice = $(this).data('product-price');

        // Add product to the first empty row or create new row
        addProductToSale(productId, productPrice);
    });

    // Add product to sale items
    function addProductToSale(productId, productPrice) {
        // Check if product is already added
        const selectedIds = getSelectedProductIds();
        if (selectedIds.includes(productId.toString())) {
            return; // Product already added, do nothing
        }

        // Find first empty row
        let emptyRow = null;
        $('.item-row').each(function() {
            const productSelect = $(this).find('select[name*="product"]');
            if (!productSelect.val()) {
                emptyRow = $(this);
                return false;
            }
        });

        // If no empty row, create new one
        if (!emptyRow) {
            $('.add-item').first().click();
            // Wait for new row to be added
            setTimeout(function() {
                emptyRow = $('.item-row').last();
                fillProductRow(emptyRow, productId, productPrice);
            }, 100);
        } else {
            fillProductRow(emptyRow, productId, productPrice);
        }
    }

    // Fill product row with data
    function fillProductRow(row, productId, productPrice) {
        const productSelect = row.find('select[name*="product"]');
        const priceInput = row.find('.price-input');
        const quantityInput = row.find('.quantity-input');

        // Set product
        productSelect.val(productId).trigger('change');

        // Set price
        priceInput.val(productPrice);

        // Set default quantity to 1
        if (!quantityInput.val() || quantityInput.val() == 0) {
            quantityInput.val(1);
        }

        // Trigger calculation
        updateCalculations();

        // Refresh product listing to disable the added product
        renderProducts();
    }

    // Expose function globally to be called from form.html
    window.refreshProductListing = function() {
        renderProducts();
    };

    // Filter products
    function filterProducts() {
        const search = $('#product-search').val().toLowerCase();
        const category = $('#category-filter').val();
        const brand = $('#brand-filter').val();

        const filters = {};
        if (search) filters.search = search;
        if (category) filters.category = category;
        if (brand) filters.brand = brand;

        loadProducts(filters);
    }

    // Search input with debounce
    let searchTimeout;
    $('#product-search').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterProducts, 300);
    });

    // Filter dropdowns
    $('#category-filter, #brand-filter').on('change', filterProducts);

    // Clear filters
    $('#clear-filters').on('click', function() {
        $('#product-search').val('');
        $('#category-filter').val('');
        $('#brand-filter').val('');
        loadProducts();
    });

    // Pagination controls
    $('#prev-page').on('click', function() {
        if (currentPage > 1) {
            currentPage--;
            renderProducts();
            updatePaginationInfo();
        }
    });

    $('#next-page').on('click', function() {
        const totalPages = Math.ceil(productsData.length / productsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderProducts();
            updatePaginationInfo();
        }
    });
});
</script>
