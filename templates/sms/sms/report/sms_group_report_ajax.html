{% load static %}
<style>
    .message-column:hover,
    .receiver-column:hover {
        cursor: pointer;
        background-color: #f1f1f1;
        color: #ff9f43;
    }
</style>
<div id="sms-list">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Message</th>
                    <th>Total Number</th>
                    <th>Total SMS</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for sms in sms_list %}
                    <tr>
                        <td class="message-column" data-message="{{ sms.message }}">
                            {% if sms.message|length > 15 %}
                                {{ sms.message|slice:":15" }}...
                            {% else %}
                                {{ sms.message }}
                            {% endif %}
                        </td>
                        <td class="receiver-column" data-receiver="{{ sms.receiver }}">
                            {{ sms.total_sms }}
                        </td>
                        <td>{{ sms.total_number_of_messages }}</td>
                        <td>{{ sms.sent_date }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Links -->
    <div class="pagination-container d-flex justify-content-between">
        <div class="pagination table-info">
            {% if sms_list %}
                <p>
                    Showing 
                    {{ sms_list.start_index }} 
                    to 
                    {{ sms_list.end_index }} 
                    of 
                    {{ sms_list.paginator.count }} 
                    entries
                </p>
            {% endif %}
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <!-- Always show the first page -->
                {% if 1 != sms_list.number and sms_list.number > 4 %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1" data-page="1">1</a>
                    </li>
                {% endif %}
    
                <!-- Show ellipsis if there is a gap between first and current page -->
                {% if sms_list.number > 4 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
    
                <!-- Display pages near the current page -->
                {% for num in sms_list.paginator.page_range %}
                
                    {% if sms_list.number < 5 %}
                        {% if num <= 5 %}
                            <li class="page-item {% if sms_list.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}" data-page="{{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% else %}
                        {% if num >= sms_list.number|add:-1 and num <= sms_list.number|add:1 %}
                            <li class="page-item {% if sms_list.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}" data-page="{{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endif %}
                    
                    
                {% endfor %}
    
                <!-- Show ellipsis if there is a gap between current and last page -->
                {% if sms_list.number < sms_list.paginator.num_pages|add:-3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
    
                <!-- Always show the last page -->
                {% if sms_list.number|add:"3" < sms_list.paginator.num_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ sms_list.paginator.num_pages }}" data-page="{{ sms_list.paginator.num_pages }}">{{ sms_list.paginator.num_pages }}</a>
                    </li>
                {% endif %} 
                {% if sms_list.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ sms_list.next_page_number }}" data-page="{{ sms_list.next_page_number }}">></a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>


<script>
$(document).ready(function() {
    // Click handler for message column to show full message
    $(document).on('click', '.message-column', function() {
        const message = $(this).data('message');
        Swal.fire({
            title: 'SMS Details',
            html: `<p><strong>Message:</strong> ${message}</p>`,
            icon: 'info',
            confirmButtonText: 'OK'
        });
    });
    
    $(document).on('click', '.receiver-column', function () {
        const receiverRaw = $(this).data('receiver');  // e.g., "['8801...', '8801...']"

        // Safely parse the stringified list to an actual JS array
        let receivers = [];
        try {
            receivers = JSON.parse(receiverRaw.replace(/'/g, '"'));
        } catch (e) {
            console.error('Invalid receiver list format:', e);
        }
        {% comment %} const receivers = receiverRaw.split(',').map(item => [item.trim()]);  // Make 2D array for Excel {% endcomment %}
    
        Swal.fire({
            title: 'Receiver list',
            html: `
                <p><strong>Receivers:</strong></p>
                <textarea readonly style="width:100%; height:150px;">${receiverRaw}</textarea>
                <br><button id="downloadExcelBtn" class="swal2-confirm swal2-styled" style="margin-top:10px;">Download as Excel</button>`,
            showConfirmButton: true,
            confirmButtonText: 'Close',
            didOpen: () => {
                document.getElementById('downloadExcelBtn').addEventListener('click', function () {
                    const worksheet = XLSX.utils.aoa_to_sheet([
                        ["Receiver List"],
                        [],
                        ...receivers.map(number => [number])
                    ]);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Receivers");
                    XLSX.writeFile(workbook, "receivers.xlsx");
                });
            }
        });
    });
});
</script>